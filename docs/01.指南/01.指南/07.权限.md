---
title: 权限
date: 2021-11-21
permalink: /pages/7a0a31/
article: false
---

## 前言

后台项目区别于其他项目的一大特点，就是权限验证及其安全性。正如我们开发时一般做的第一个页面，就是登录页面，在最开始我们就需要考虑到权限的问题。

思路一：

- 登录：用户输入用户名和密码后，首先通过前端的输入格式和辅助工具（如短信验证码、滑块图）进行验证，再`login`到服务端验证此用户名密码是否正确。服务端会返回一个`token`，拿到`token`之后（这个`token`会被存到`cookie/session/store`中，起到用户登录状态辅助作用），前端会根据`token`再去拉取一个`info`的接口来获取用户的详细信息。需要注意的是，我们应该把`login`跟 `info`分开进行

- 权限：通过`token`拿到`info`获取到`role`，再动态地根据`role`拿到权限相关的信息（如路由表、按钮权限）

思路二：

- 前端控制页面级权限：拿到`role`，映射出前端写好的路由表控制能够看到的页面（如侧边栏选项，也即路由表）
- 后端控制请求权限：用户操作后向服务端发送请求头携带`token`的请求，服务端验证是否有该操作的权限

两种方式都可行，这里推荐第二种方式，理由分析：

- 更好的前后端分离模式：思路一可能导致前端页面的每次增加都要后端配合修改路由与权限，而思路二完美的将页面路由跟操作权限分开
- 更细粒度的权限控制：不同角色可以访问相同页面，但是当前页面操作权限不同，想想是不是思路二更好呢

通过上面的讲述，我们可以知道权限控制有两种，登录权限（是否能成功登录）和角色权限（角色信息如菜单路由、操作按钮权限）。来看看具体是如何实现的吧！

## 登录验证

### 前端验证

一般验证方式：

- 输入格式验证（一般用于注册，严格点也可以用于登录）
- 辅助验证：短信验证码、字符验证码、滑块图、文案编辑等

本项目暂时没有使用以上验证方式，即将开放，敬请期待！

### 后端验证

后端一般通过数据对比进行验证。

点击登录后，前端向服务器发送用户名和密码，后端验证正确后，会返回一个 token，我们把它存到 sessionStorage，作为一个权限标识。

## 权限验证

上面我们已经详细讲过权限中有关路由模块的内容，这里我们再看看更细粒化的按钮权限。

通常我们会以角色来做权限判定，执行对应的权限操作。

### 直接使用 info (用户信息)

```typescript
import { storageSession } from "/@/utils/storage"; // 拿到用户的 info

function changRole() {
  if (unref(purview) === "admin") {
    // 是 admin，则有权限作如下操作
    storageSession.setItem("info", {
      username: "test",
      accessToken: "eyJhbGciOiJIUzUxMiJ9.test",
    });
    window.location.reload();
  } else {
    storageSession.setItem("info", {
      username: "admin",
      accessToken: "eyJhbGciOiJIUzUxMiJ9.admin",
    });
    window.location.reload();
  }
}
```

### 角色指令

指令可以帮助我们像使用 v-model 一样，快速的达到想要的效果，角色判定也是如此。

```typescript
<script setup lang="ts">
const auth = ref<boolean>(storageSession.getItem("info").username || "admin");
......
</script>

<template>
  <div>
    <el-radio-group v-model="auth" @change="changRole">
      <el-radio-button label="admin"></el-radio-button>
      <el-radio-button label="test"></el-radio-button>
    </el-radio-group>
    <p v-auth="'v-admin'">只有admin可看</p>
    <p v-auth="'v-test'">只有test可看</p>
  </div>
</template>
```

有关指令的封装请戳指令篇~
