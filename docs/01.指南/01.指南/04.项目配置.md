---
title: 项目配置
date: 2021-11-16 10:04:27
permalink: /pages/5d83b5/
---

## 环境变量配置

习惯性地，项目的环境变量配置在根目录下，以三种环境配置为主。

```
├── .env                                                    # 基础环境变量
├── .env.development                                        # 开发环境变量
├── .env.production                                         # 生产环境变量
```

### 环境变量

Vite 在一个特殊的 `import.meta.env` 对象上暴露环境变量。这里有一些在所有情况下都可以使用的内建变量：

- **`import.meta.env.MODE`**: {string} 应用运行的[模式](https://cn.vitejs.dev/guide/env-and-mode.html#modes)。
- **`import.meta.env.BASE_URL`**: {string} 部署应用时的基本 URL。他由[`base` 配置项](https://cn.vitejs.dev/config/#base)决定。
- **`import.meta.env.PROD`**: {boolean} 应用是否运行在生产环境。
- **`import.meta.env.DEV`**: {boolean} 应用是否运行在开发环境 (永远与 `import.meta.env.PROD`相反)。

### .env 文件

> Vite 使用 `dotenv` 在你的项目根目录下从以下文件加载额外的环境变量：

```
.env                # 所有情况下都会加载
.env.local          # 所有情况下都会加载，但会被 git 忽略
.env.[mode]         # 只在指定模式下加载
.env.[mode].local   # 只在指定模式下加载，但会被 git 忽略
```

加载的环境变量也会通过 `import.meta.env` 暴露给客户端源码。

为了防止意外地将一些环境变量泄漏到客户端，只有以 `VITE_` 为前缀的变量才会暴露给经过 `Vite` 处理的代码

### 模式

默认情况下，开发服务器 (`dev` 命令) 运行在 `development` (开发) 模式，而 `build` 以及 `serve` 命令则运行在 `production` (生产) 模式。

`.env.development`

```
# port
VITE_PORT = 8848
# title
VITE_TITLE = huohuo-system
# version
VITE_VERSION = 1.0.0
# open
VITE_OPEN = false
# public path
VITE_PUBLIC_PATH = /
# Cross-domain proxy, you can configure multiple
VITE_PROXY = [ ["/api", "http://127.0.0.1:3000" ] ]
```

这意味着当执行 `vite build` 时，它会自动加载 `.env.production` 中可能存在的环境变量（本项目中）：

```
# public path
VITE_PUBLIC_PATH = /manages/
```

在项目应用中，就可以通过 `import.meta.env.VITE_PUBLIC_PATH` 来做各种处理。

除了开发和生产模式，你仍然可以扩展其他的模式，比如 `staging` (预发布|预上线) 模式：

- 创建 `.env.staging` 文件
- 构建应用：`vite build --mode staging`

> 一般我们会把模式设置为 `development` 开发环境，`build` 默认执行 `development` 环境

```
# .env.staging
NODE_ENV=development
```

### TS 智能提示

在 Vite 官方文档中有说到：

默认情况下，Vite 为 `import.meta.env` 提供了类型定义。

你可能想要在代码中获取这些以 `VITE_` 为前缀的用户自定义环境变量的 Typescript 智能提示。

你可以在 `src` 目录下创建一个 `env.d.ts` 文件，接着按下面这样增加一个 `ImportMetaEnv` 的定义：

```typescript
interface ImportMetaEnv extends Readonly<Record<string, string>> {
  readonly VITE_APP_TITLE: string;
  // 更多环境变量...
}

interface ImportMeta {
  readonly env: ImportMetaEnv;
}
```

本项目中，在 `global.d.ts` 类型定义文件中做了如下定义：

```typescript
type Recordable<T = any> = Record<string, T>; // 后面需要用到

interface ImportMetaEnv extends ViteEnv {
  __: unknown;
}

declare interface ViteEnv {
  VITE_PORT: number;
  VITE_TITLE: string;
  VITE_VERSION: string;
  VITE_USE_MOCK: boolean;
  VITE_USE_PWA: boolean;
  VITE_PUBLIC_PATH: string;
  VITE_PROXY: [string, string][];
  VITE_GLOB_APP_TITLE: string;
  VITE_GLOB_APP_SHORT_NAME: string;
  VITE_USE_CDN: boolean;
  VITE_DROP_CONSOLE: boolean;
  VITE_BUILD_COMPRESS: "gzip" | "brotli" | "none";
  VITE_BUILD_COMPRESS_DELETE_ORIGIN_FILE: boolean;
  VITE_LEGACY: boolean;
  VITE_USE_IMAGEMIN: boolean;
  VITE_GENERATE_UI: string;
}
```

### 配置

涉及的核心文件有：`build/utils.ts`、`vite.config.ts`

项目中我们在 `utils.ts`文件对环境变量进行了封装

```typescript
const warpperEnv = (envConf: Recordable): ViteEnv => {
  const ret: any = {};

  for (const envName of Object.keys(envConf)) {
    let realName = envConf[envName].replace(/\\n/g, "\n");
    realName =
      realName === "true" ? true : realName === "false" ? false : realName;

    if (envName === "VITE_PORT") {
      realName = Number(realName);
    }
    if (envName === "VITE_PROXY" && realName) {
      try {
        realName = JSON.parse(realName.replace(/'/g, '"'));
      } catch (error) {
        realName = "";
      }
    }
    ret[envName] = realName;
    if (typeof realName === "string") {
      process.env[envName] = realName;
    } else if (typeof realName === "object") {
      process.env[envName] = JSON.stringify(realName);
    }
  }
  return ret;
};
```

最后来到关键的配置文件`vite.config.ts`

```typescript
import { UserConfigExport, ConfigEnv, loadEnv } from "vite"; // 引入 vite 自带的环境配置所需工具
import { warpperEnv } from "./build/utils"; // 引入封装好的环境变量工具

const root: string = process.cwd(); // 返回 Node.js 进程的当前工作目录

export default ({ command, mode }: ConfigEnv): UserConfigExport => {
  const { VITE_PORT, VITE_PUBLIC_PATH, VITE_PROXY } = warpperEnv(
    loadEnv(mode, root) // 检查 process.cwd() 路径下 mode(即.env)环境文件，输出NODE_ENV和VITE_开头的键值对
  ); // 输出封装处理后的键值对，供下面使用
  const prodMock = true;
  return {
    /**
     * 基本公共路径
     * /manages/ 可根据项目部署域名的后缀自行填写（全局搜/manages/替换）
     * @default '/'
     */
    base:
      process.env.NODE_ENV === "production" ? "/manages/" : VITE_PUBLIC_PATH,
    root,
    server: {
      port: VITE_PORT, // 端口号，默认 3000
      host: "0.0.0.0",
      proxy: createProxy(VITE_PROXY) // 本地跨域代理
    },
  }

```
